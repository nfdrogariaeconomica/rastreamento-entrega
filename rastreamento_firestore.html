<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interativo</title>
    <!-- Carrega o Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS para o mapa (Novo) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- Configuração do Google Font: Inter -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #map {
            height: 85%; /* Ocupa a maior parte da tela */
            width: 100%;
            border-radius: 0.5rem; /* Cantos arredondados */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6">
    <div class="max-w-4xl mx-auto w-full h-full">
        <!-- Cabeçalho de Instrução -->
        <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Visualizador de Mapa (OpenStreetMap)</h1>
        <p class="text-sm text-green-600 bg-green-100 p-3 rounded-lg mb-4 text-center">
            ✅ Solução Aplicada: Tempo limite (timeout) estendido para 10 segundos para garantir o carregamento do Leaflet em redes muito lentas.
        </p>

        <!-- Container do Mapa -->
        <div id="map" class="shadow-xl"></div>
    </div>

    <!--
        Carrega o Leaflet JS PRIMEIRO para garantir que L.map esteja definido.
    -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""></script>

    <script>
        // Variável global para armazenar a instância do mapa
        let mapInstance = null;
        let markerInstance = null;

        // Função de inicialização do mapa (agora usando Leaflet)
        function initMap() {
            // Ponto central padrão (Exemplo: Rio de Janeiro, Brasil)
            const defaultCenter = [-22.9068, -43.1729]; // [Latitude, Longitude]

            // VERIFICAÇÃO CRÍTICA AQUI: Confirma se L está definido antes de usar L.map
            if (typeof L === 'undefined' || typeof L.map !== 'function') {
                throw new Error("A biblioteca Leaflet não foi totalmente carregada ou L.map não é uma função.");
            }

            try {
                // Se já existir uma instância, remove-a e limpa (opcional, mas seguro)
                if (mapInstance) {
                    mapInstance.remove();
                }

                // Cria o novo mapa e o renderiza no elemento com id="map"
                // Usa Leaflet (L) para inicializar o mapa.
                mapInstance = L.map('map').setView(defaultCenter, 12);

                // Adiciona a camada de mapa (tiles) do OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(mapInstance);

                // Adiciona um marcador no centro
                markerInstance = L.marker(defaultCenter).addTo(mapInstance)
                    .bindPopup("Ponto Central Padrão").openPopup();

            } catch (e) {
                // Este bloco de erro captura problemas de inicialização do Leaflet
                console.error("Erro ao inicializar o mapa Leaflet:", e);
                const mapDiv = document.getElementById("map");
                mapDiv.innerHTML = `
                    <div class="flex items-center justify-center h-full text-center p-4">
                        <p class="text-lg text-red-700">
                            Erro de carregamento do mapa: ${e.message}.
                        </p>
                    </div>
                `;
            }
        }

        /**
         * Inicializa o mapa com uma lógica de segurança (polling) para esperar pelo Leaflet.
         * Parâmetros ajustados para 10 segundos de espera total.
         */
        function safeInitMap(retries = 50, delay = 200) { // 50 * 200ms = 10000ms (10 segundos)
            if (typeof L !== 'undefined' && typeof L.map === 'function') {
                // A biblioteca está carregada, pode inicializar
                initMap();
            } else if (retries > 0) {
                // A biblioteca ainda não está carregada, tenta novamente
                setTimeout(() => safeInitMap(retries - 1, delay), delay);
            } else {
                // Falhou após múltiplas tentativas
                const mapDiv = document.getElementById("map");
                mapDiv.innerHTML = `
                    <div class="flex items-center justify-center h-full text-center p-4">
                        <p class="text-lg text-red-700">
                            Erro fatal: A biblioteca Leaflet não carregou após o tempo limite de 10 segundos. Por favor, verifique a sua ligação à internet ou tente reiniciar a aplicação.
                        </p>
                    </div>
                `;
            }
        }

        // Chama a função de inicialização de segurança após o carregamento da janela
        window.addEventListener('load', () => {
            const mapDiv = document.getElementById('map');
            if (mapDiv && mapDiv.offsetHeight < 200) {
                mapDiv.style.minHeight = '400px';
            }
            safeInitMap(); 
        });
    </script>
</body>
</html>
